<!DOCTYPE html>
<meta charset="utf-8">

<head>
  <style>

  div{
    text-align:center;
  }

  .bar{
    fill: steelblue;
  }

  .bar:hover{
    fill: brown;
  }

  .bar_line{
    fill: black;
  }

  .axis {
    font: 10px sans-serif;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  </style>
</head>

<body>

<div id="container" class="svg-container">
  <svg preserveAspectRatio="xMidYMid meet" id = "svgY"></svg>
  <svg preserveAspectRatio="xMidYMid meet" id = "svgYDx"></svg>
  <svg preserveAspectRatio="xMidYMid meet" id = "svgChart"></svg>
</div>

<script src="http://d3js.org/d3.v3.min.js"></script>

<script>


// load the data
var url_data = "https://raw.githubusercontent.com/francescopisu/subanalysis/master/data.json"
var url_sample = "https://raw.githubusercontent.com/francescopisu/subanalysis/master/sample.json"
d3.json(url_data, function(error, data) {

  var episodes = [];
  i = 0;
  data.forEach(series => {
    series.seasons.forEach(season => {
      season.episodes.forEach(episode => {
        episodes.push({
          id: i++,
          number: episode.id_,
          wh: episode.wh,
          season: season.id_,
          series: series.id_
        })
      });
    });
  });
  console.log(episodes);

  var seasons = [];
  i = 0;
  data.forEach(series => {
    series.seasons.forEach(season => {
        seasons.push({
          id: i++,
          number: season.id_,
          wh: season.avg_wh,
          series: series.id_
        })
      });
    });
  console.log(seasons)

  var series = [];
  i = 0;
  data.forEach(single_series => {
        series.push({
          id: i++,
          number: single_series.id_,
          wh: single_series.avg_wh,
          series: single_series.id_
        })
    });
  console.log(series)



  array_visualized = episodes;

  // set the dimensions of the canvas
  var margin = {top: 20, right: 20, bottom: 70, left: 40},
      bar_width = 2,
      width = bar_width*array_visualized.length - margin.left - margin.right,
      height = 600 - margin.top - margin.bottom;


  // set the ranges
  var x = d3.scale.ordinal().rangeBands([0, width], .05);

  var y = d3.scale.linear().range([height, 0]);

  // define the axis
  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom")


  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left")
      .ticks(10);


  // add the Y axis SVG element
  var svgY = d3.select("#svgY")
      .attr("width", margin.left)
      .attr("height", height + margin.top + margin.bottom)
      .style("position","fixed")
      .style("left","0")
      .style("top","auto")
      .style("overflow-y","scroll")
      .style("background-color","white")
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

   // add the Y axis SVG element on the right
  var svgYDx = d3.select("#svgYDx")
      .attr("width", margin.left)
      .attr("height", height + margin.top + margin.bottom)
      .style("position","fixed")
      .style("right","1")
      .style("top","auto")
      .style("overflow-y","scroll")
      .style("background-color","white")
    .append("g")
      .attr("transform",
            "translate(" + margin.left  + "," + margin.top + ")");

  // add the chart SVG element
  var svg = d3.select("#svgChart")
      .style("overflow-x","scroll")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")")


  // scale the range of the data
  x.domain(array_visualized.map(item => item.id));
  y.domain([0, (d3.max(array_visualized, function(item) { return item.wh; }))*1.05]);

  // -----------  NUOVE RIGHE -------------- //
  labels = array_visualized.map(item => item.number)
  console.log(labels)
  xAxis.tickFormat(function(d, i) { return labels[i] })
  .tickSize(0);

  // add axis
  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
    .selectAll("text")
      .style("text-anchor", "middle")
      .attr("dy", ".9em");

  svgY.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 5)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Words/hour");

   svgYDx.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 5)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Words/hour"); 

  // Add bar chart
  var bars = svg.selectAll("bar")
      .data(array_visualized)
    .enter();

    // w/h bars
    bars.append("rect")
      .attr("class", "bar")
      .attr("x", function(item) { return x(item.id); })
      .attr("width", x.rangeBand())
      .attr("y", function(item) { return y(item.wh); })
      .attr("height", function(item) { return height - y(item.wh); });

    // average w/h line
    bars.append("rect")
        .attr("class", "bar_line")
        .attr("x", function(item) { return x(item.id); })
        .attr("width", x.rangeBand() + 2)
        .attr("y", function(item) { return y(data[item.series].avg_wh); })
        .attr("height", function(item) { return 1; });

/*
    var zoom = d3.behavior.zoom()
        .scaleExtent([.5, 20])  // This control how much you can unzoom (x0.5) and zoom (x20)
        // .extent([[0, 0], [width, height]])
        .on("zoom", updateChart);

    zoom(svg);

    // A function that updates the chart when the user zoom and thus new boundaries are available
    function updateChart() {
      console.log("zoom")
      // recover the new scale
      // console.log(d3.event.translate[0])
      // console.log(d3.event.scale)
    }*/
});

</script>

</body>
